name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  JAVA_VERSION: '17'

jobs:
  # ==========================================
  # Build
  # ==========================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run Checkstyle
        run: ./mvnw -ntp checkstyle:check

      - name: Build with Maven (skip tests)
        run: ./mvnw -ntp clean package -DskipTests -Pprod

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar

  # ==========================================
  # Build and Push Docker Image
  # ==========================================
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image with Jib
        run: |
          ./mvnw -ntp compile jib:build -Pprod \
            -Djib.to.image=${{ secrets.DOCKER_REGISTRY }}/transfer-service:${{ github.sha }} \
            -Djib.to.tags=latest,${{ github.sha }}

  # ==========================================
  # Deploy to Environment
  # ==========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ secrets.APP_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Kubernetes
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          echo "$KUBECONFIG_DATA" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          
          # Update deployment with new image
          kubectl set image deployment/transfer-service \
            transfer-service=${{ secrets.DOCKER_REGISTRY }}/transfer-service:${{ github.sha }} \
            -n ondmoney
          
          # Wait for rollout to complete
          kubectl rollout status deployment/transfer-service -n ondmoney --timeout=300s

      - name: Cleanup
        if: always()
        run: rm -f /tmp/kubeconfig

      - name: Notify on Success
        if: success()
        run: echo "✅ Transfer Service deployed successfully!"

      - name: Notify on Failure
        if: failure()
        run: echo "❌ Transfer Service deployment failed!"
